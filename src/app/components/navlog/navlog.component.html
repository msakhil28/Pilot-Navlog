<div class="h-full flex flex-col">
  <!-- Top Stats Bar -->
  <div
    class="flex-shrink-0 bg-sky-card/50 backdrop-blur-md border-b border-white/5 p-6 mb-6 rounded-2xl flex items-center justify-between shadow-lg">
    <div>
      <h2 class="text-xl font-bold text-white tracking-tight">Active Flight Plan</h2>
      <p class="text-xs text-sky-muted uppercase tracking-wider font-mono mt-1">{{ navlogRows().length }} Navigation
        Legs</p>
    </div>
    <div class="flex gap-8">
      <div class="text-right">
        <p class="text-[10px] text-sky-muted uppercase tracking-widest font-bold">Total Dist</p>
        <p class="text-2xl font-mono text-white font-light">{{ totalDistance() }} <span
            class="text-sm text-sky-muted font-sans">NM</span></p>
      </div>
      <div class="text-right">
        <p class="text-[10px] text-sky-muted uppercase tracking-widest font-bold">Est. Time</p>
        <p class="text-2xl font-mono text-white font-light">{{ formatEte(totalEte()) }}</p>
      </div>
      <div class="text-right">
        <p class="text-[10px] text-sky-muted uppercase tracking-widest font-bold">Total Fuel</p>
        <p class="text-2xl font-mono text-avionics-green font-light">{{ totalFuel().toFixed(1) }} <span
            class="text-sm text-sky-muted font-sans">Gal</span></p>
      </div>
    </div>
  </div>

  <!-- Timeline Container -->
  <div class="flex-1 overflow-y-auto pr-4 custom-scrollbar relative">

    <!-- Vertical Connectors -->
    <div
      class="absolute left-8 top-8 bottom-0 w-0.5 bg-gradient-to-b from-flight-blue via-sky-muted/20 to-transparent z-0">
    </div>

    <div class="space-y-6 relative z-10 pb-20">
      @for (row of navlogRows(); track trackById(index, row); let index = $index) {
      <div class="group relative pl-20 transition-all duration-300">

        <!-- Waypoint Marker (Timeline Node) -->
        <div
          class="absolute left-6 top-8 w-5 h-5 -ml-2.5 rounded-full border-4 border-[#0f172a] bg-flight-blue shadow-[0_0_15px_rgba(59,130,246,0.5)] z-20 group-hover:scale-125 transition-transform">
        </div>
        <div class="absolute left-[26px] top-[50px] bottom-[-24px] w-px border-l border-dashed border-white/10 z-0">
        </div>

        <!-- Leg Card -->
        <div
          class="bg-sky-card/80 backdrop-blur-md border border-white/5 rounded-2xl p-6 hover:bg-sky-light/5 transition-all duration-300 hover:border-flight-blue/30 hover:shadow-xl hover:shadow-flight-blue/5 group-focus-within:border-flight-blue group-focus-within:ring-1 group-focus-within:ring-flight-blue/50">

          <!-- Grid Layout for Inputs -->
          <div class="grid grid-cols-12 gap-x-6 gap-y-6">

            <!-- Column 1: Waypoint Info -->
            <div class="col-span-12 md:col-span-3 space-y-4 border-r border-white/5 pr-6">
              <div class="group/input">
                <label
                  class="block text-[10px] uppercase tracking-wider text-sky-muted font-bold mb-1.5 group-focus-within/input:text-flight-blue transition-colors">Waypoint
                  ID</label>
                <input type="text" [(ngModel)]="row.waypoint" name="waypoint-{{row.id}}"
                  class="w-full bg-sky-dark/50 border border-white/10 rounded-lg py-2 px-3 text-white font-mono uppercase focus:ring-1 focus:ring-flight-blue focus:border-flight-blue transition-all"
                  placeholder="IDENT">
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div class="group/input">
                  <label class="block text-[10px] uppercase tracking-wider text-sky-muted font-bold mb-1.5">VOR</label>
                  <input type="text" [(ngModel)]="row.vorIdent" name="vorIdent-{{row.id}}"
                    class="w-full bg-sky-dark/50 border border-white/10 rounded-lg py-1.5 px-2 text-sm text-white font-mono uppercase focus:ring-1 focus:ring-flight-blue transition-all"
                    placeholder="---">
                </div>
                <div class="group/input">
                  <label class="block text-[10px] uppercase tracking-wider text-sky-muted font-bold mb-1.5">Freq</label>
                  <input type="number" step="0.01" [(ngModel)]="row.vorFreq" name="vorFreq-{{row.id}}"
                    class="w-full bg-sky-dark/50 border border-white/10 rounded-lg py-1.5 px-2 text-sm text-white font-mono focus:ring-1 focus:ring-flight-blue transition-all"
                    placeholder="108.0">
                </div>
              </div>
            </div>

            <!-- Column 2: Flight Dynamics (Wind Triangle) -->
            <div class="col-span-12 md:col-span-5 space-y-4 border-r border-white/5 pr-6">
              <!-- Main Flight Parameters -->
              <div class="grid grid-cols-3 gap-4 bg-sky-dark/30 p-3 rounded-xl border border-white/5">
                <div class="group/input">
                  <label
                    class="block text-[10px] uppercase tracking-wider text-sky-muted font-bold mb-1.5 text-center">Course</label>
                  <input type="number" [(ngModel)]="row.course" (ngModelChange)="calculateRow(row.id)"
                    name="course-{{row.id}}"
                    class="w-full bg-transparent border-b border-white/20 py-1 text-center text-lg font-mono font-bold text-white focus:outline-none focus:border-flight-blue transition-all placeholder-white/10"
                    placeholder="000">
                </div>
                <div class="group/input relative">
                  <label
                    class="block text-[10px] uppercase tracking-wider text-sky-muted font-bold mb-1.5 text-center">Heading</label>
                  <div class="text-center text-lg font-mono font-bold text-flight-blue py-1">{{ row.mh !== null ?
                    (row.mh | number:'1.0-0') : '---' }}°</div>
                  <div class="absolute -top-1 right-0 text-[10px] text-sky-muted/50">MH</div>
                </div>
                <div class="group/input">
                  <label
                    class="block text-[10px] uppercase tracking-wider text-sky-muted font-bold mb-1.5 text-center">Dist
                    (NM)</label>
                  <input type="number" [(ngModel)]="row.distance" (ngModelChange)="calculateRow(row.id)"
                    name="distance-{{row.id}}"
                    class="w-full bg-transparent border-b border-white/20 py-1 text-center text-lg font-mono font-bold text-white focus:outline-none focus:border-flight-blue transition-all placeholder-white/10"
                    placeholder="0">
                </div>
              </div>

              <!-- Environmental Inputs -->
              <div class="grid grid-cols-4 gap-3">
                <div class="group/input">
                  <label class="block text-[10px] uppercase tracking-wider text-sky-muted font-bold mb-1">Wind
                    Dir</label>
                  <input type="number" [(ngModel)]="row.windDir" (ngModelChange)="calculateRow(row.id)"
                    name="windDir-{{row.id}}"
                    class="w-full bg-sky-dark/50 border border-white/10 rounded px-2 py-1 text-xs text-white font-mono focus:ring-1 focus:ring-flight-blue">
                </div>
                <div class="group/input">
                  <label class="block text-[10px] uppercase tracking-wider text-sky-muted font-bold mb-1">Wind
                    Vel</label>
                  <input type="number" [(ngModel)]="row.windVel" (ngModelChange)="calculateRow(row.id)"
                    name="windVel-{{row.id}}"
                    class="w-full bg-sky-dark/50 border border-white/10 rounded px-2 py-1 text-xs text-white font-mono focus:ring-1 focus:ring-flight-blue">
                </div>
                <div class="group/input">
                  <label class="block text-[10px] uppercase tracking-wider text-sky-muted font-bold mb-1">TAS</label>
                  <input type="number" [(ngModel)]="row.tas" (ngModelChange)="calculateRow(row.id)"
                    name="tas-{{row.id}}"
                    class="w-full bg-sky-dark/50 border border-white/10 rounded px-2 py-1 text-xs text-white font-mono focus:ring-1 focus:ring-flight-blue">
                </div>
                <div class="group/input">
                  <label class="block text-[10px] uppercase tracking-wider text-sky-muted font-bold mb-1">Var</label>
                  <input type="text" [(ngModel)]="row.variation" (ngModelChange)="calculateRow(row.id)"
                    name="variation-{{row.id}}"
                    class="w-full bg-sky-dark/50 border border-white/10 rounded px-2 py-1 text-xs text-white font-mono focus:ring-1 focus:ring-flight-blue"
                    placeholder="±Var">
                </div>
              </div>
            </div>

            <!-- Column 3: Performance & Remove -->
            <div class="col-span-12 md:col-span-4 flex flex-col justify-between">
              <div class="grid grid-cols-2 gap-4">
                <div class="bg-sky-dark/20 rounded-lg p-3 border border-white/5">
                  <span class="block text-[10px] text-sky-muted uppercase tracking-wider mb-1">Ground Speed</span>
                  <span class="block text-xl font-mono font-bold text-white">{{ row.gs !== null ? (row.gs |
                    number:'1.0-0') : '---' }} <span
                      class="text-xs font-sans text-sky-muted font-normal">kts</span></span>
                </div>
                <div class="bg-sky-dark/20 rounded-lg p-3 border border-white/5">
                  <span class="block text-[10px] text-sky-muted uppercase tracking-wider mb-1">ETE</span>
                  <span class="block text-xl font-mono font-bold text-white">{{ formatEte(row.ete) || '--:--' }}</span>
                </div>
              </div>

              <div class="mt-4 flex items-end gap-3">
                <div class="flex-1 group/input">
                  <label class="block text-[10px] uppercase tracking-wider text-sky-muted font-bold mb-1.5">GPH</label>
                  <input type="number" [(ngModel)]="row.gph" (ngModelChange)="calculateRow(row.id)"
                    name="gph-{{row.id}}"
                    class="w-full bg-sky-dark/50 border border-white/10 rounded-lg py-2 px-3 text-white font-mono focus:ring-1 focus:ring-flight-blue transition-all"
                    placeholder="GPH">
                </div>
                <div class="flex-1 bg-avionics-green/10 rounded-lg p-2 border border-avionics-green/20">
                  <span class="block text-[10px] text-avionics-green uppercase tracking-wider mb-0.5">Fuel Req</span>
                  <span class="block text-lg font-mono font-bold text-white">{{ row.fuel !== null ? row.fuel : '--'
                    }}</span>
                </div>

                <button (click)="removeRow(row.id)"
                  class="mb-1 p-2 text-sky-muted hover:text-avionics-red hover:bg-avionics-red/10 rounded-lg transition-colors"
                  title="Remove Leg">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd"
                      d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
                      clip-rule="evenodd" />
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <!-- Validation/Error Indicator (Optional) -->
          @if (row.wca === null && row.course && row.windVel && row.tas) {
          <div class="absolute top-2 right-2 text-avionics-red animate-pulse" title="Invalid Wind Correction Angle">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd"
                d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
                clip-rule="evenodd" />
            </svg>
          </div>
          }
        </div>
      </div>
      }
    </div>

    <!-- Add Leg Fab -->
    <div class="fixed bottom-8 right-8 z-30">
      <button (click)="addRow()"
        class="bg-flight-blue text-white rounded-full p-4 shadow-2xl shadow-flight-blue/40 hover:scale-110 hover:bg-flight-focus transition-all duration-300 group ring-4 ring-black/20">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 group-hover:rotate-90 transition-transform" fill="none"
          viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
      </button>
    </div>

  </div>

  <!-- Educational/Instructions Footer (AdSense Compliance) -->
  <div
    class="mt-8 mb-4 bg-sky-dark/30 backdrop-blur-md rounded-2xl p-6 sm:p-8 border border-white/5 mx-auto max-w-4xl w-full">
    <div class="flex items-center gap-3 mb-4 border-b border-white/5 pb-4">
      <div class="bg-flight-blue/10 p-2 rounded-lg text-flight-blue">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
        </svg>
      </div>
      <div>
        <h2 class="text-lg font-bold text-white">Cross-Country Flight Planning</h2>
        <p class="text-xs text-sky-muted uppercase tracking-wider">Instructions & Theory</p>
      </div>
    </div>

    <div class="prose prose-sm prose-invert max-w-none text-sky-muted font-light leading-relaxed">
      <h3 class="text-white font-bold mb-2">Using the Digital Navlog</h3>
      <p class="mb-4">
        This tool replaces the traditional paper navigation log for VFR flight planning. It automatically calculates the
        Wind Correction Angle (WCA), Ground Speed (GS), Time Enroute (ETE), and Fuel Burn for each leg of your flight.
      </p>

      <h3 class="text-white font-bold mb-2">Step-by-Step Guide</h3>
      <ol class="list-decimal pl-5 space-y-2 mb-4">
        <li><strong>Define Waypoints:</strong> Enter the ID for each checkpoint (e.g., "KDEN", "VOR").</li>
        <li><strong>Measure Course & Distance:</strong> Use your Sectional Chart or EFB to determine the True Course
          (TC) and Distance for each leg.</li>
        <li><strong>Weather Data:</strong> Input the Winds Aloft (Direction and Velocity) and True Airspeed (TAS)
          gathered from your performance charts.</li>
        <li><strong>Results:</strong> The tool instantly derives your True Heading (TH) and Ground Speed (GS). Add
          Magnetic Variation to get Magnetic Heading (MH).</li>
      </ol>

      <div class="bg-avionics-red/10 border border-avionics-red/20 p-4 rounded-xl mt-6">
        <p class="text-avionics-red font-medium text-xs">
          <strong>Safety Note:</strong> Always cross-check these values with a mechanical E6B or official flight
          planning software before flight. Gaps in terrain or airspace awareness are not accounted for in this
          simplified log.
        </p>
      </div>
    </div>
  </div>
</div>